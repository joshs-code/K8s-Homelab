## Step 1: Install Ubuntu 25.04 & Prepare Kubernetes Cluster

> **Goal**: Fresh install Ubuntu 25.04 on both nodes, set up passwordless SSH, disable swap, configure kernel modules, install `containerd` + Kubernetes tools.

---

## 1. Install Ubuntu 25.04 Server

**On both machines (Dell Latitude E6430 & Datto Alto 3)**:

- Boot from **Ubuntu 25.04 Server ISO**
- Select **"Erase disk and install Ubuntu"**
- Set hostnames:
  - `ubuntu1` → Dell Latitude
  - `ubuntu2` → Datto Alto 3
- Create user: `joshua`
- Enable **OpenSSH Server**
- Reboot

---

## 2. Passwordless SSH from Daily Laptop → `ubuntu1`

**Run on your daily laptop**:

```bash
# Add to /etc/hosts
sudo nano /etc/hosts
```

```text
192.168.12.17 ubuntu1   # Dell Latitude (Control Plane)
192.168.12.227 ubuntu2  # Datto Alto 3 (Worker)
```

```bash
# Generate SSH key
ssh-keygen -t ed25519 -C "your@email.com"

# Copy key to ubuntu1
ssh-copy-id joshua@ubuntu1
```

> Now `ssh joshua@ubuntu1` works without password.

---

## 3. Prepare Both Nodes (`ubuntu1` & `ubuntu2`)

**Run on both `ubuntu1` and `ubuntu2`**:

### Disable Swap
```bash
sudo swapoff -a
sudo nano /etc/fstab
```
```diff
- /swap.img none swap sw 0 0
+ # /swap.img none swap sw 0 0
```

### Load Kernel Modules
```bash
sudo nano /etc/modules-load.d/k8s.conf
```
```text
overlay
br_netfilter
```

### Configure sysctl
```bash
sudo nano /etc/sysctl.d/k8s.conf
```
```text
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
```
```bash
sudo sysctl --system
```

### Reboot
```bash
sudo reboot
```

---

## 4. Install `containerd` + Kubernetes Tools

**On both nodes**:

### Install containerd
```bash
sudo apt install containerd -y
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
sudo systemctl restart containerd
sudo systemctl enable containerd
```

### Add Kubernetes Repo
```bash
sudo mkdir -p -m 755 /etc/apt/keyrings
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
```

### Install Kubernetes Tools
```bash
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
sudo systemctl enable --now kubelet
```

---

## 5. Initialize Cluster (`ubuntu1` Only)

### Install Helm
```bash
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh
helm version
```

### Get IP Address
```bash
ip route show default
# Example: src 192.168.12.14
```

### Initialize Cluster
```bash
sudo kubeadm init \
  --pod-network-cidr=192.168.0.0/16 \
  --apiserver-advertise-address=192.168.12.14
```

> **Error**: `conntrack not found`
```bash
sudo apt install conntrack -y
```
Then rerun `kubeadm init`.

### Configure `kubectl`
```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

### Install Calico CNI
```bash
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/calico.yaml
```

Wait:
```bash
watch kubectl get pods -n kube-system
```

---

## 6. Prepare 1.6TB Storage (`ubuntu2` Only)

### Create Logical Volume
```bash
sudo vgs
sudo lvcreate -L 1.6T -n datastore ubuntu-vg
```

### Format & Mount
```bash
sudo vgchange -ay
sudo mkfs.ext4 /dev/mapper/ubuntu--vg-datastore
sudo mkdir -p /mnt/datastore
sudo mount /dev/mapper/ubuntu--vg-datastore /mnt/datastore
df -h /mnt/datastore
```

### Make Permanent
```bash
sudo blkid /dev/mapper/ubuntu--vg-datastore
# Copy UUID
sudo nano /etc/fstab
```
```text
UUID=your-uuid-here /mnt/datastore ext4 defaults 0 2
```
```bash
sudo umount /mnt/datastore
sudo mount -a
df -h /mnt/datastore
```

### Install NFS Server
```bash
sudo apt install nfs-kernel-server -y
echo "/mnt/datastore 192.168.12.0/24(rw,sync,no_subtree_check,no_root_squash)" | sudo tee /etc/exports
sudo exportfs -ra
sudo systemctl restart nfs-kernel-server
sudo systemctl enable nfs-kernel-server
sudo systemctl status nfs-kernel-server
```

---

## 7. Join `ubuntu2` to Cluster

**On `ubuntu1`**:
```bash
kubeadm token create --print-join-command
```

**On `ubuntu2`**:
```bash
sudo kubeadm join 192.168.12.14:6443 --token ... --discovery-token-ca-cert-hash sha256:...
```

> **Error**: `conntrack` → `sudo apt install conntrack -y`

**Verify on `ubuntu1`**:
```bash
kubectl get nodes
```

---

## 8. Deploy Pi-hole with GitOps (`ubuntu1`)

### Label Worker
```bash
kubectl label nodes ubuntu2 node-type=worker
```

### Install Git
```bash
sudo apt install git -y
git config --global user.name "joshs-code"
git config --global user.email "your@email.com"
```

### Generate SSH Key
```bash
ssh-keygen -t ed25519 -C "your@email.com"
cat ~/.ssh/id_ed25519.pub
```
→ Add to GitHub → Settings → SSH Keys

### Create Git Repo
```bash
mkdir -p ~/k8s-homelab/pihole
cd ~/k8s-homelab
git init
```

### Create `pihole/values-prod.yaml`
```yaml
persistence:
  enabled: true
  existingClaim: pihole-storage
nodeSelector:
  node-type: worker
```

### Commit & Push
```bash
git add .
git commit -m "Add Pi-hole config"
git remote add origin https://github.com/joshs-code/K8s-Homelab.git
git branch -M main
git push -u origin main
```

### Add Helm Repo
```bash
helm repo add mojo2600 https://mojo2600.github.io/pihole-kubernetes
helm repo update
```

### Deploy Pi-hole
```bash
helm upgrade --install my-pihole mojo2600/pihole \
  --namespace pihole \
  -f ~/k8s-homelab/pihole/values-prod.yaml \
  --create-namespace
```

---

## 9. Expose Pi-hole Web UI (`ubuntu1`)

```bash
kubectl patch svc my-pihole-web -n pihole -p '{"spec":{"type":"NodePort","ports":[{"port":80,"nodePort":30080}]}}'
```

---

## 10. Access Pi-hole

```bash
# Open in browser
http://192.168.12.14:30080/admin
```

```bash
# Get password
kubectl get secret my-pihole-password -n pihole -o jsonpath='{.data.password}' | base64 -d; echo
```
